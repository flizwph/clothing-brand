# Руководство по миграции с API v1 на v2

## Статус API

Начиная с версии `1.0.1` API v1 помечен как устаревший (deprecated) и будет полностью удален в будущих версиях. Рекомендуется перейти на использование API v2 как можно скорее.

### Статус устаревших эндпоинтов:

При обращении к устаревшим эндпоинтам (v1) вы получите ответ с кодом статуса `410 Gone` и сообщением о необходимости использовать новую версию API. Тело ответа будет содержать информацию о соответствующем эндпоинте v2.

```json
{
  "message": "This API endpoint is deprecated. Please use /api/auth/v2 endpoints instead.",
  "newEndpoint": "/api/auth/v2/login"
}
```

Также будут добавлены HTTP-заголовки:
- `X-Deprecated-API: true`
- `X-New-API-Endpoint: /api/auth/v2/login`

## Изменения между v1 и v2 API

### 1. Регистрация пользователя

**v1 (устаревший):**
```
POST /api/auth/register
```

**v2 (новый):**
```
POST /api/auth/v2/register
```

Изменения:
- Формат запроса и ответа остались теми же
- Улучшена обработка ошибок и валидация

### 2. Авторизация

**v1 (устаревший):**
```
POST /api/auth/login
```

**v2 (новый):**
```
POST /api/auth/v2/login
```

Изменения:
- Добавлена защита от перебора (блокировка аккаунта после многократных неудачных попыток)
- Ответ содержит более подробные сообщения об ошибках
- Токен также возвращается в заголовке `Authorization`

### 3. Проверка валидности токена

**v1 (устаревший):**
```
POST /api/auth/token/validate
Content-Type: application/json

{
  "token": "eyJhbGciOiJIUzI1NiJ9..."
}
```

**v2 (новый):**
```
GET /api/auth/v2/validate-token
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

Изменения:
- Изменен метод с `POST` на `GET`
- Токен передается в заголовке `Authorization`, а не в теле запроса
- Более детальная информация в ответе

### 4. Обновление токена

**v1 (устаревший):**
```
POST /api/auth/refresh
```

**v2 (новый):**
```
POST /api/auth/v2/refresh
```

Изменения:
- Улучшенная проверка валидности refresh-токена
- Добавлено сообщение об успешном выполнении в ответе

### 5. Выход из системы

**v1 (устаревший):**
```
POST /api/auth/logout
Content-Type: application/json

{
  "username": "test_user"
}
```

**v2 (новый):**
```
POST /api/auth/v2/logout
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

Изменения:
- Не требуется передавать имя пользователя в теле запроса
- Имя пользователя извлекается из токена JWT

### 6. Новые функции (только в v2)

#### 6.1. Изменение пароля
```
POST /api/auth/v2/change-password
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...

{
  "username": "test_user",
  "currentPassword": "old_password",
  "newPassword": "new_password"
}
```

#### 6.2. Запрос на сброс пароля
```
POST /api/auth/v2/password-reset/request

{
  "username": "test_user",
  "email": "user@example.com"
}
```

## Стратегия миграции

1. **Обновите все клиентские приложения** для использования новых эндпоинтов API v2.

2. **Если вы не можете сразу обновить все клиентские приложения**, вы можете временно включить перенаправление с v1 на v2, изменив настройку в `application.properties`:

```properties
api.legacy.redirect-enabled=true
```

В этом режиме устаревшие эндпоинты будут перенаправлять запросы к новому API, добавляя соответствующее предупреждение в ответ.

3. **Если вам необходимо сохранить оригинальную реализацию API v1** (не рекомендуется), вы можете включить её с помощью настройки:

```properties
api.legacy.direct-implementation=true
```

Это приведёт к использованию оригинальных контроллеров v1 вместо прокси-контроллеров.

4. **После полного перехода на v2 API**, рекомендуется отключить перенаправление и оставить только сообщения об устаревании API.

## Сроки поддержки v1 API

- **1.0.1 - 1.1.x**: v1 API помечен как устаревший, но продолжает работать
- **1.2.0 и выше**: v1 API будет полностью удален

## Техническая реализация

В текущей версии устаревшие конечные точки обрабатываются прокси-контроллерами:

- `LegacyAuthControllerProxy`
- `LegacyTokenValidationProxy`

Эти контроллеры заменяют оригинальные контроллеры v1, предоставляя разработчикам понятную информацию о переходе на новую версию API.

Оригинальные контроллеры v1 (`AuthController` и `TokenValidationController`) отключены по умолчанию и могут быть включены только с помощью специальной настройки конфигурации. 