# Сравнение версий API аутентификации (v1 vs v2)

## Общая информация
В системе реализованы две версии API для аутентификации:
- **v1** - Старая версия (`/api/auth`)
- **v2** - Новая версия с CQRS подходом (`/api/auth/v2`)

Рекомендуется использовать **v2** API для всех новых интеграций.

## Основные различия

### Структурные изменения
- **v1**: Использует традиционный подход с сервисами
- **v2**: Использует CQRS (Command Query Responsibility Segregation) подход

### Обработка ошибок
- **v1**: Менее детальная обработка ошибок
- **v2**: Более структурированные ответы с детальными сообщениями об ошибках

### Безопасность
- **v2**: Улучшенный механизм защиты от атак перебором (блокировка аккаунта)
- **v2**: Более надежный механизм обновления и валидации токенов

## Сравнение эндпоинтов

### Регистрация
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | `/api/auth/register` | `/api/auth/v2/register` |
| Метод | POST | POST |
| Запрос | Идентичен | Идентичен |
| Ответ | Менее детальный | Более детальный, включает `verificationCode` |
| Коды ошибок | 409, 500 | 409, 500 |

### Вход в систему
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | `/api/auth/login` | `/api/auth/v2/login` |
| Метод | POST | POST |
| Запрос | Идентичен | Идентичен |
| Ответ | Базовая информация | Расширенная информация и HTTP заголовок с токеном |
| Коды ошибок | 401, 403 | 401, 403, 429 (блокировка) |

### Проверка токена
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | `/api/auth/token/validate` | `/api/auth/v2/validate-token` |
| Метод | POST | GET |
| Запрос | Токен в теле запроса | Токен в заголовке `Authorization` |
| Ответ | Базовая информация | Детальная информация |
| Коды ошибок | 401 | 401, 500 |

### Обновление токена
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | `/api/auth/refresh` | `/api/auth/v2/refresh` |
| Метод | POST | POST |
| Запрос | Идентичен | Идентичен |
| Ответ | Только токен | Токен и сообщение успеха |
| Коды ошибок | 401 | 400, 401, 500 |

### Выход из системы
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | `/api/auth/logout` | `/api/auth/v2/logout` |
| Метод | POST | POST |
| Запрос | Требуется имя пользователя в теле | Не требует тела, имя пользователя извлекается из токена |
| Ответ | 204 No Content | 204 No Content |
| Коды ошибок | 401, 404 | 401, 404, 500 |

### Изменение пароля
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | Не реализовано | `/api/auth/v2/change-password` |
| Метод | - | POST |
| Требования | - | Авторизация + текущий пароль |
| Ответ | - | Сообщение об успехе |
| Коды ошибок | - | 400, 401, 500 |

### Сброс пароля
| Функционал | v1 API | v2 API |
|------------|--------|--------|
| URL | Не реализовано | `/api/auth/v2/password-reset/request` |
| Метод | - | POST |
| Требования | - | Имя пользователя и email |
| Ответ | - | Сообщение о дальнейших шагах |
| Коды ошибок | - | 400, 404, 500 |

## Рекомендации по миграции
При переходе с v1 на v2 API необходимо учесть следующие изменения:

1. **Проверка токена**: 
   - Изменился метод с POST на GET
   - Токен передается в заголовке, а не в теле запроса

2. **Выход из системы**:
   - Не нужно передавать имя пользователя в теле запроса
   - Информация о пользователе извлекается из токена

3. **Обработка ошибок**:
   - Добавлен новый код ошибки 429 (Too Many Requests) при блокировке аккаунта
   - Более детальные сообщения об ошибках

4. **Новый функционал**:
   - Изменение пароля
   - Сброс пароля 